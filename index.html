
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visor de Luminarias</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; background: #ddd; }
    #map { height: 100vh; width: 100vw; }
    .control {
      position: absolute; top: 10px; left: 10px;
      background: white; padding: 10px; border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1000;
    }
    select, button, input { margin-top: 5px; display: block; width: 100%; }
    .popup-form label { display:block; margin:5px 0 2px; }
  </style>
</head>
<body>
<div class="control">
  <label>Buscar plancheta:</label>
  <select id="planchetaSelector">
    <option value="">-- Seleccionar --</option>
  </select>
  <button onclick="enableAdd()">Agregar luminaria</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([-34.6, -58.4], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'OpenStreetMap'
}).addTo(map);

const planchetas = {
  "Plancheta A": [[-34.595, -58.41], [-34.59, -58.40]],
  "Plancheta B": [[-34.6, -58.41], [-34.595, -58.40]],
  "Plancheta C": [[-34.595, -58.405], [-34.59, -58.395]]
};

const markerLayer = L.layerGroup().addTo(map);
let adding = false;

function enableAdd() {
  adding = true;
  map.once('click', e => {
    addMarker(e.latlng);
    adding = false;
  });
}

function addMarker(latlng, data = {}) {
  const marker = L.marker(latlng, { draggable: true }).addTo(markerLayer);

  const container = document.createElement("div");
  container.className = "popup-form";
  container.innerHTML = `
    <label>Tipo:</label>
    <select id="tipo">
      <option>LED</option><option>Sodio</option><option>Mercurio</option>
      <option>Apagada</option><option>Decorativa</option><option>Desconocida</option>
    </select>
    <label>Estado:</label>
    <select id="estado">
      <option>Encendida</option><option>Apagada</option>
    </select>
    <label>Cantidad:</label>
    <input type="number" id="cantidad" value="${data.cantidad || 1}" min="1"/>
    <label>Potencia (W):</label>
    <input type="text" id="potencia" value="${data.potencia || ''}"/>
    <button onclick="saveData(this)">Guardar</button>
    <button onclick="deleteMarker(this)">Eliminar</button>
  `;
  marker.bindPopup(container).openPopup();
  marker.options.data = data;
}

function saveData(btn) {
  const popup = btn.closest('.popup-form');
  const marker = markerLayer.getLayers().find(m => m.getPopup().getContent() === popup);
  if (!marker) return;

  marker.options.data = {
    tipo: popup.querySelector('#tipo').value,
    estado: popup.querySelector('#estado').value,
    cantidad: popup.querySelector('#cantidad').value,
    potencia: popup.querySelector('#potencia').value
  };
  marker.closePopup();
}

function deleteMarker(btn) {
  const popup = btn.closest('.popup-form');
  const marker = markerLayer.getLayers().find(m => m.getPopup().getContent() === popup);
  if (marker) markerLayer.removeLayer(marker);
}

const select = document.getElementById('planchetaSelector');
Object.keys(planchetas).forEach(p => {
  const opt = document.createElement('option');
  opt.text = p;
  select.add(opt);
});
select.addEventListener('change', () => {
  const coords = planchetas[select.value];
  if (coords) {
    const bounds = L.latLngBounds(coords);
    map.fitBounds(bounds);
  }
});
</script>
</body>
</html>
