
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visor de Luminarias</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #ddd;
    }
    #map {
      height: 100vh;
    }
    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    select, button {
      margin-top: 5px;
      width: 100%;
    }
    .popup-form {
      display: flex;
      flex-direction: column;
    }
    .popup-form input, .popup-form select {
      margin: 3px 0;
    }
  </style>
</head>
<body>
<div id="panel">
  <label><strong>Buscar plancheta:</strong></label>
  <select id="planchetaSelect"></select>
  <button id="addBtn">Agregar luminaria</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([-34.6, -58.4], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OSM'
  }).addTo(map);

  const planchetas = {
    "Plancheta A": [[-34.61, -58.41], [-34.60, -58.40]],
    "Plancheta B": [[-34.605, -58.41], [-34.595, -58.40]],
    "Plancheta C": [[-34.6, -58.41], [-34.59, -58.40]]
  };

  const planchetaLayers = {};
  for (const nombre in planchetas) {
    const bounds = planchetas[nombre];
    const rectangle = L.rectangle(bounds, { color: "orange", weight: 1, fillOpacity: 0.2 }).addTo(map);
    planchetaLayers[nombre] = rectangle;
  }

  const select = document.getElementById("planchetaSelect");
  Object.keys(planchetas).forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    select.appendChild(opt);
  });

  select.addEventListener("change", () => {
    const bounds = planchetas[select.value];
    map.fitBounds(bounds);
  });

  let addMode = false;
  document.getElementById("addBtn").addEventListener("click", () => {
    addMode = true;
    alert("Hacé clic en el mapa dentro de una plancheta para agregar una luminaria.");
  });

  const luminarias = [];

  function agregarLuminaria(latlng) {
    const marker = L.circleMarker(latlng, {
      radius: 8,
      fillColor: "orange",
      color: "#000",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    }).addTo(map);

    const form = document.createElement("div");
    form.className = "popup-form";
    form.innerHTML = `
      <label>Tipo:</label>
      <select>
        <option>LED</option>
        <option>Sodio</option>
        <option>Apagada</option>
        <option>Mercurio</option>
        <option>Decorativa</option>
        <option>Desconocida</option>
      </select>
      <label>Observaciones:</label>
      <input type="text" placeholder="Notas..."/>
      <button class="delete">Eliminar</button>
    `;

    form.querySelector(".delete").addEventListener("click", () => {
      map.removeLayer(marker);
    });

    marker.bindPopup(form).openPopup();
    luminarias.push(marker);
  }

  map.on("click", e => {
    if (!addMode) return;
    const clickedPoint = e.latlng;
    let dentroDePlancheta = false;

    for (const nombre in planchetaLayers) {
      if (planchetaLayers[nombre].getBounds().contains(clickedPoint)) {
        dentroDePlancheta = true;
        break;
      }
    }

    if (dentroDePlancheta) {
      agregarLuminaria(clickedPoint);
    } else {
      alert("Hacé clic dentro de una plancheta.");
    }
    addMode = false;
  });
</script>
</body>
</html>
