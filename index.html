
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Visor de Luminarias</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; background: #ddd; }
    #map { height: 100vh; width: 100vw; }
    .control {
      position: absolute; top: 10px; left: 10px;
      background: white; padding: 10px; border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1000;
    }
    select, button { margin-top: 5px; display: block; width: 100%; }
    .popup-form label { display:block; margin:5px 0 2px; }
  </style>
</head>
<body>
<div class="control">
  <label>Buscar plancheta:</label>
  <select id="planchetaSelector">
    <option value="">-- Seleccionar --</option>
  </select>
  <button onclick="enableAdd()">Agregar luminaria</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([-34.6, -58.45], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 20,
}).addTo(map);

const planchetas = {
  "Plancheta A": [[-34.595, -58.46], [-34.59, -58.455]],
  "Plancheta B": [[-34.59, -58.45], [-34.585, -58.445]],
  "Plancheta C": [[-34.585, -58.44], [-34.58, -58.435]],
};

const luminarias = [];

function dibujarPlanchetas() {
  for (const [nombre, coords] of Object.entries(planchetas)) {
    const bounds = [coords[0], coords[1]];
    const rect = L.rectangle(bounds, {
      color: 'orange', weight: 1, fillOpacity: 0.3
    }).addTo(map);
    rect.bindTooltip(nombre, { permanent: true, direction: 'center' });
    rect.nombre = nombre;
    rect.bounds = rect.getBounds();
  }
}
dibujarPlanchetas();

document.getElementById("planchetaSelector").innerHTML +=
  Object.keys(planchetas).map(p => `<option value="${p}">${p}</option>`).join('');

document.getElementById("planchetaSelector").addEventListener("change", e => {
  const bounds = planchetas[e.target.value];
  if (bounds) map.fitBounds([bounds[0], bounds[1]]);
});

let adding = false;
function enableAdd() {
  adding = true;
  map.getContainer().style.cursor = 'crosshair';
}

map.on("click", (e) => {
  if (!adding) return;
  adding = false;
  map.getContainer().style.cursor = '';

  const marker = L.circleMarker(e.latlng, {
    radius: 8, fillColor: "purple", color: "#000", weight: 1, fillOpacity: 0.8
  }).addTo(map);

  const popup = L.popup().setContent(`
    <div class="popup-form">
      <label>Tipo:</label>
      <select id="tipo">
        <option>LED</option>
        <option>Sodio</option>
        <option>Mercurio</option>
        <option>Decorativa</option>
        <option>Desconocida</option>
      </select>
      <label>Estado:</label>
      <select id="estado">
        <option>Encendida</option>
        <option>Apagada</option>
        <option>Desconocido</option>
      </select>
      <button onclick="guardarLuminaria(this)">Guardar</button>
      <button onclick="eliminarLuminaria(this)">Eliminar</button>
    </div>
  `);

  marker.bindPopup(popup).openPopup();
  marker._info = { latlng: e.latlng };
  luminarias.push(marker);
});

function guardarLuminaria(btn) {
  const popup = btn.closest('.leaflet-popup-content');
  const tipo = popup.querySelector('#tipo').value;
  const estado = popup.querySelector('#estado').value;
  const marker = luminarias.find(m => m.getPopup().getContent().includes(btn.outerHTML));
  if (marker) {
    marker.setStyle({ fillColor: tipo === 'LED' ? 'green' : tipo === 'Sodio' ? 'orange' : 'gray' });
    marker.bindTooltip(`Tipo: ${tipo}<br>Estado: ${estado}`, { permanent: false });
    marker._info.tipo = tipo;
    marker._info.estado = estado;
    marker.closePopup();
  }
}

function eliminarLuminaria(btn) {
  const marker = luminarias.find(m => m.getPopup().getContent().includes(btn.outerHTML));
  if (marker) {
    map.removeLayer(marker);
    const i = luminarias.indexOf(marker);
    if (i > -1) luminarias.splice(i, 1);
  }
}
</script>
</body>
</html>
